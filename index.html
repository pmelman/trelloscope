<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trelloscope</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <script>
    const CAPABILITIES = {
      'board-buttons': function(t) {
        return [{
          icon: {
            dark: './icon.png',
            light: './icon.png'
          },
          text: 'Copy Board',
          callback: async function(t) {
            const lists = await t.lists('all');
            const cards = await Promise.all(
              lists.map(async list => {
                const listCards = await t.cards('all', { list: list.id });
                return listCards.map(card => ({
                  listName: list.name,
                  cardName: card.name,
                  cardDesc: card.desc
                }));
              })
            );

            // Format the board content
            const boardContent = lists.map(list => {
              const listCards = cards.flat().filter(card => card.listName === list.name);
              return `Column: ${list.name}\n${listCards.map(card => 
                `  Card: ${card.cardName}${card.cardDesc ? '\n  Description: ' + card.cardDesc : ''}`
              ).join('\n')}\n`;
            }).join('\n');

            // Copy to clipboard
            try {
              await navigator.clipboard.writeText(boardContent);
              await t.alert({
                message: 'Board content copied to clipboard!',
                duration: 3
              });
            } catch (err) {
              console.error('Failed to copy:', err);
              await t.alert({
                message: 'Failed to copy board content',
                display: 'error',
                duration: 3
              });
            }
          }
        }];
      }
    };

    window.TrelloPowerUp.initialize(CAPABILITIES);

    /* Original AI/LLM Code (Commented Out)
    const TRELLO_API_KEY = '546d844af4419ecd2e260eb6638f2d74';
    
    // Settings Management
    async function loadSettings(t) {
      try {
        return await t.get('board', 'private', {
          apiKey: '',
          model: 'openai/gpt-4o-mini',
          temperature: 0.7,
          maxTokens: 1000
        });
      } catch (error) {
        console.error('Error loading settings:', error);
        return {};
      }
    }

    // Board State Reading
    async function getBoardState(t) {
      const board = await t.board('all');
      const lists = await t.lists('all');
      const cards = await Promise.all(
        lists.map(async list => {
          const listCards = await t.cards('all', { list: list.id });
          return listCards.map(card => ({
            ...card,
            listName: list.name
          }));
        })
      );
      
      return {
        board,
        lists: lists.map(list => ({
          id: list.id,
          name: list.name,
          cards: cards.flat().filter(card => card.listName === list.name)
        }))
      };
    }

    // LLM Integration
    async function takeLLMTurn(t, settings) {
      try {
        const boardState = await getBoardState(t);
        const prompt = constructPrompt(boardState);
        
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${settings.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: settings.model,
            messages: [{
              role: 'system',
              content: `You are playing the role of a player in the Microscope storytelling game. 
              You should analyze the current board state and decide whether to create a Period (list) 
              or Event (card) based on the game's rules. Your response should be in JSON format with 
              action: "period" or "event", and the corresponding details.`
            }, {
              role: 'user',
              content: prompt
            }],
            temperature: settings.temperature,
            max_tokens: settings.maxTokens
          })
        });

        if (!response.ok) {
          throw new Error('API request failed');
        }

        const result = await response.json();
        const action = JSON.parse(result.choices[0].message.content);
        
        if (action.action === 'period') {
          await t.createList({
            name: action.name,
            pos: 'bottom'
          });
        } else if (action.action === 'event') {
          await t.createCard({
            name: action.name,
            desc: action.description,
            pos: 'bottom',
            listId: action.listId
          });
        }

        await t.alert({
          message: `Successfully created ${action.action}: ${action.name}`,
          duration: 5
        });
      } catch (error) {
        console.error('Error taking LLM turn:', error);
        await t.alert({
          message: 'Error taking LLM turn. Please check settings and try again.',
          duration: 5,
          display: 'error'
        });
      }
    }

    // Prompt Construction
    function constructPrompt(boardState) {
      return `Current Board State:
      Board Name: ${boardState.board.name}
      
      Timeline:
      ${boardState.lists.map(list => `
        Period: ${list.name}
        Events:
        ${list.cards.map(card => `
          - ${card.name}
          ${card.desc ? `    Description: ${card.desc}` : ''}
        `).join('\n')}
      `).join('\n')}
      
      Based on the Microscope rules and the current board state:
      1. Analyze whether it's more appropriate to create a Period (list) or Event (card)
      2. If creating a Period, ensure it fits chronologically and thematically
      3. If creating an Event, choose an appropriate Period and create a meaningful event
      4. Do not create Scenes
      
      Respond with a JSON object containing:
      For Period: { "action": "period", "name": "period name" }
      For Event: { "action": "event", "name": "event name", "description": "event details", "listId": "chosen period id" }`;
    }
    */
  </script>
</body>
</html>
