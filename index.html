<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trelloscope</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      padding: 1rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    .settings-section {
      margin-bottom: 1rem;
    }
    .settings-section label {
      display: block;
      margin-bottom: 0.5rem;
    }
    .settings-section input, .settings-section select {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .error {
      color: red;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div id="settings" style="display: none;">
    <h2>Trelloscope Settings</h2>
    <div class="settings-section">
      <label for="apiKey">OpenRouter API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your OpenRouter API key">
    </div>
    <div class="settings-section">
      <label for="model">Model:</label>
      <select id="model">
        <option value="openai/gpt-4">GPT-4</option>
        <option value="anthropic/claude-2">Claude 2</option>
        <option value="google/palm-2">PaLM 2</option>
      </select>
    </div>
    <div class="settings-section">
      <label for="temperature">Temperature:</label>
      <input type="range" id="temperature" min="0" max="100" value="70">
      <span id="temperatureValue">0.7</span>
    </div>
    <div class="settings-section">
      <label for="maxTokens">Max Tokens:</label>
      <input type="number" id="maxTokens" value="1000" min="100" max="4000">
    </div>
    <button id="saveSettings">Save Settings</button>
    <div id="settingsError" class="error"></div>
  </div>

  <script>
    const CAPABILITIES = {
      'board-buttons': function(t) {
        return [{
          icon: {
            dark: './icon.png',
            light: './icon.png'
          },
          text: 'LLM Turn',
          callback: async function(t) {
            const settings = await loadSettings(t);
            if (!settings.apiKey) {
              return t.modal({
                url: './index.html',
                title: 'Settings Required',
                height: 400
              });
            }
            await takeLLMTurn(t, settings);
          }
        }];
      },
      'show-settings': function(t) {
        return t.modal({
          url: './index.html',
          title: 'Trelloscope Settings',
          height: 400
        });
      }
    };

    // Initialize Power-Up
    window.TrelloPowerUp.initialize({
      ...CAPABILITIES,
      'authorization-status': async function(t) {
        const settings = await loadSettings(t);
        return { authorized: Boolean(settings.apiKey) };
      }
    });

    // Settings Management
    async function loadSettings(t) {
      try {
        return await t.get('board', 'private', {
          apiKey: '',
          model: 'openai/gpt-4',
          temperature: 0.7,
          maxTokens: 1000
        });
      } catch (error) {
        console.error('Error loading settings:', error);
        return {};
      }
    }

    // Board State Reading
    async function getBoardState(t) {
      const board = await t.board('all');
      const lists = await t.lists('all');
      const cards = await Promise.all(
        lists.map(async list => {
          const listCards = await t.cards('all', { list: list.id });
          return listCards.map(card => ({
            ...card,
            listName: list.name
          }));
        })
      );
      
      return {
        board,
        lists: lists.map(list => ({
          id: list.id,
          name: list.name,
          cards: cards.flat().filter(card => card.listName === list.name)
        }))
      };
    }

    // LLM Integration
    async function takeLLMTurn(t, settings) {
      try {
        const boardState = await getBoardState(t);
        const prompt = constructPrompt(boardState);
        
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${settings.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: settings.model,
            messages: [{
              role: 'system',
              content: `You are playing the role of a player in the Microscope storytelling game. 
              You should analyze the current board state and decide whether to create a Period (list) 
              or Event (card) based on the game's rules. Your response should be in JSON format with 
              action: "period" or "event", and the corresponding details.`
            }, {
              role: 'user',
              content: prompt
            }],
            temperature: settings.temperature,
            max_tokens: settings.maxTokens
          })
        });

        if (!response.ok) {
          throw new Error('API request failed');
        }

        const result = await response.json();
        const action = JSON.parse(result.choices[0].message.content);
        
        if (action.action === 'period') {
          await t.createList({
            name: action.name,
            pos: 'bottom'
          });
        } else if (action.action === 'event') {
          await t.createCard({
            name: action.name,
            desc: action.description,
            pos: 'bottom',
            listId: action.listId
          });
        }

        await t.alert({
          message: `Successfully created ${action.action}: ${action.name}`,
          duration: 5
        });
      } catch (error) {
        console.error('Error taking LLM turn:', error);
        await t.alert({
          message: 'Error taking LLM turn. Please check settings and try again.',
          duration: 5,
          display: 'error'
        });
      }
    }

    // Prompt Construction
    function constructPrompt(boardState) {
      return `Current Board State:
      Board Name: ${boardState.board.name}
      
      Timeline:
      ${boardState.lists.map(list => `
        Period: ${list.name}
        Events:
        ${list.cards.map(card => `
          - ${card.name}
          ${card.desc ? `    Description: ${card.desc}` : ''}
        `).join('\n')}
      `).join('\n')}
      
      Based on the Microscope rules and the current board state:
      1. Analyze whether it's more appropriate to create a Period (list) or Event (card)
      2. If creating a Period, ensure it fits chronologically and thematically
      3. If creating an Event, choose an appropriate Period and create a meaningful event
      4. Do not create Scenes
      
      Respond with a JSON object containing:
      For Period: { "action": "period", "name": "period name" }
      For Event: { "action": "event", "name": "event name", "description": "event details", "listId": "chosen period id" }`;
    }

    // UI Event Handlers
    if (document.getElementById('settings').style.display !== 'none') {
      const t = window.TrelloPowerUp.iframe();

      document.getElementById('temperature').addEventListener('input', (e) => {
        document.getElementById('temperatureValue').textContent = (e.target.value / 100).toFixed(1);
      });

      document.getElementById('saveSettings').addEventListener('click', async () => {
        try {
          const settings = {
            apiKey: document.getElementById('apiKey').value,
            model: document.getElementById('model').value,
            temperature: Number(document.getElementById('temperature').value) / 100,
            maxTokens: Number(document.getElementById('maxTokens').value)
          };

          await t.set('board', 'private', settings);
          await t.closePopup();
        } catch (error) {
          document.getElementById('settingsError').textContent = 
            'Error saving settings. Please try again.';
        }
      });

      // Load existing settings
      loadSettings(t).then(settings => {
        if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        if (settings.model) document.getElementById('model').value = settings.model;
        if (settings.temperature) {
          document.getElementById('temperature').value = settings.temperature * 100;
          document.getElementById('temperatureValue').textContent = settings.temperature.toFixed(1);
        }
        if (settings.maxTokens) document.getElementById('maxTokens').value = settings.maxTokens;
      });
    }
  </script>
</body>
</html>
